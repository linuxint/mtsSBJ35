<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="schdule">

    <!-- statementType="CALLABLE" => 프로시저를 사용할때 선언 -->
    <insert id="insertCalendar" parameterType="java.util.HashMap" statementType="CALLABLE">
        { CALL
            makeCalendar(
                    #{startdate,mode=IN, jdbcType=VARCHAR},
                    #{enddate,  mode=IN, jdbcType=VARCHAR}
            )
        }
    </insert>

    <select id="selectCalendar" resultType="com.devkbil.mtssbj.schedule.CalendarVO" parameterType="com.devkbil.mtssbj.schedule.MonthVO">
        SELECT /* selectCalendar */ DISTINCT CDDATE, CDDD, CDDAYOFWEEK, SHCOLOR
          FROM COM_DATE CD LEFT OUTER JOIN SCH_HOLIDAY ON CDMM = SHMONTH AND CDDD = SHDAY AND SHCOLOR != 'GREEN' AND DELETEFLAG = 'N'
         WHERE CDYEAR=#{year} AND CDMM=#{month}
         ORDER BY CDDATE
    </select>

    <select id="selectSchList4Calen" resultType="com.devkbil.mtssbj.schedule.SchDetailVO" parameterType="com.devkbil.mtssbj.common.ExtFieldVO">
        SELECT SSNO, SDSEQ, SSTITLE, USERNO, SDHOUR, SDMINUTE, FONTCOLOR
        FROM (
                 SELECT NULL SSNO, NULL SDSEQ, SHTITLE SSTITLE, NULL USERNO, NULL SDHOUR, NULL SDMINUTE, SHCOLOR FONTCOLOR
                 FROM SCH_HOLIDAY SH
                 WHERE SHMONTH=extract (month from TO_DATE(#{field2})) AND SHDAY=extract (day from TO_DATE(#{field2})) AND SH.DELETEFLAG='N'
                 UNION ALL
                 SELECT SD.SSNO, SDSEQ, SSTITLE, USERNO, SD.SDHOUR, SD.SDMINUTE, NULL FONTCOLOR
                 FROM SCH_DETAIL SD
                          LEFT OUTER JOIN SCH_SCHEDULE SS ON SS.SSNO=SD.SSNO
                 WHERE SDDATE=#{field2} AND SS.DELETEFLAG='N' AND SS.SSISOPEN='Y'
                 UNION ALL
                 SELECT SD.SSNO, SDSEQ, SSTITLE, USERNO, SD.SDHOUR, SD.SDMINUTE, NULL FONTCOLOR
                 FROM SCH_DETAIL SD
                          LEFT OUTER JOIN SCH_SCHEDULE SS ON SS.SSNO=SD.SSNO
                 WHERE SDDATE=#{field2} AND SS.DELETEFLAG='N' AND SS.SSISOPEN='N' AND USERNO=#{field1}
             )DS
        ORDER BY SDHOUR, SDMINUTE, SSNO
    </select>


    <sql id="includeSch">
        WHERE DELETEFLAG='N'
    </sql>

    <select id="selectSchCount" resultType="Integer" parameterType="com.devkbil.mtssbj.search.SearchVO">
        SELECT COUNT(*)
          FROM SCH_SCHEDULE TC
         <include refid="includeSch"/>
    </select>

    <select id="selectSchList" resultType="com.devkbil.mtssbj.schedule.SchVO" parameterType="com.devkbil.mtssbj.search.SearchVO">
        SELECT * FROM (
            SELECT ROW_NUMBER() OVER (ORDER BY SSNO DESC) AS RNUM
                 , SSTITLE, SSTYPE, SSSTARTDATE, SSSTARTHOUR, SSSTARTMINUTE, SSENDDATE, SSENDHOUR
                 , SSENDMINUTE, SSREPEATTYPE, SSREPEATEND, SSCONTENTS, SSISOPEN, TC.USERNO, USERNM
              FROM SCH_SCHEDULE TC
             INNER JOIN COM_USER CU ON TC.USERNO=CU.USERNO
             <include refid="includeSch"/>
         )
         <if test="rowStart != null">
             WHERE RNUM BETWEEN ${rowStart} AND ${rowStart-1}+${displayRowCount}
             -- OFFSET ${rowStart-1} ROWS FETCH FIRST ${displayRowCount} ROWS ONLY -- oracle12c
         </if>
    </select>

    <insert id="insertSch" parameterType="com.devkbil.mtssbj.schedule.SchVO">
        <selectKey resultType="String" keyProperty="ssno" order="BEFORE">
            SELECT SSNO_SEQ.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO SCH_SCHEDULE(SSNO, SSTITLE, SSTYPE, SSSTARTDATE, SSSTARTHOUR, SSSTARTMINUTE, SSENDDATE, SSENDHOUR,
                    SSENDMINUTE, SSREPEATTYPE, SSREPEATOPTION, SSREPEATEND, SSCONTENTS, SSISOPEN, USERNO, CHGDATE, REGDATE, DELETEFLAG)
        VALUES (#{ssno}, #{sstitle}, #{sstype}, #{ssstartdate}, #{ssstarthour}, #{ssstartminute}, #{ssenddate}, #{ssendhour},
                #{ssendminute}, #{ssrepeattype}, #{ssrepeatoption}, #{ssrepeatend}, #{sscontents}, #{ssisopen}, #{userno}, SYSDATE, SYSDATE, 'N')
    </insert>

    <update id="updateSch" parameterType="com.devkbil.mtssbj.schedule.SchVO">
        UPDATE SCH_SCHEDULE
           SET SSTITLE=#{sstitle}, SSTYPE=#{sstype}, SSSTARTDATE=#{ssstartdate}, SSSTARTHOUR=#{ssstarthour}, SSSTARTMINUTE=#{ssstartminute}, SSENDDATE=#{ssenddate}
             , SSENDHOUR=#{ssendhour}, SSENDMINUTE=#{ssendminute}, SSREPEATTYPE=#{ssrepeattype}, SSREPEATOPTION=#{ssrepeatoption}, SSREPEATEND=#{ssrepeatend}
             , SSCONTENTS=#{sscontents}, SSISOPEN=#{ssisopen}, CHGDATE=SYSDATE
         WHERE SSNO=#{ssno} 
    </update>

    <insert id="insertSchDetail" parameterType="com.devkbil.mtssbj.schedule.SchDetailVO" >
        INSERT INTO SCH_DETAIL(SSNO, SDSEQ, SDDATE, SDHOUR, SDMINUTE)
            VALUES(#{ssno}, #{sdseq}, #{sddate}, #{sdhour}, #{sdminute})
    </insert>

    <delete id="deleteSchDetail" parameterType="String">
        DELETE
          FROM SCH_DETAIL
         WHERE SSNO=#{ssno} 
    </delete>

    <select id="selectSchOne" parameterType="com.devkbil.mtssbj.schedule.SchVO" resultType="com.devkbil.mtssbj.schedule.SchVO">
        SELECT SSNO, SSTITLE, SSTYPE, SSSTARTDATE, SSSTARTHOUR, SSSTARTMINUTE, SSENDDATE, SSENDHOUR
             , SSENDMINUTE, SSREPEATTYPE, SSREPEATOPTION, SSREPEATEND, SSCONTENTS, SSISOPEN, TC.USERNO, USERNM
          FROM SCH_SCHEDULE TC
         INNER JOIN COM_USER CU ON TC.USERNO=CU.USERNO
         WHERE TC.DELETEFLAG='N' AND SSNO=#{ssno}
    </select>

    <select id="selectSchOne4Read" parameterType="com.devkbil.mtssbj.schedule.SchVO" resultType="com.devkbil.mtssbj.schedule.SchVO">
        SELECT SSNO, SSTITLE, CC1.CODENM as SSTYPE, SSSTARTDATE, SSSTARTHOUR, SSSTARTMINUTE, SSENDDATE, SSENDHOUR
             , SSENDMINUTE, SSREPEATTYPE, CC2.CODENM SSREPEATTYPENM, SSREPEATEND, SSCONTENTS, CC3.CODENM as SSISOPEN, TC.USERNO, USERNM
          FROM SCH_SCHEDULE TC
         INNER JOIN COM_USER CU ON TC.USERNO=CU.USERNO
         INNER JOIN COM_CODE CC1 ON CC1.CODECD=TC.SSTYPE AND CC1.CLASSNO=4
         INNER JOIN COM_CODE CC2 ON CC2.CODECD=TC.SSREPEATTYPE AND CC2.CLASSNO=5
         INNER JOIN COM_CODE CC3 ON CC3.CODECD=TC.SSISOPEN AND CC3.CLASSNO=6
         WHERE TC.DELETEFLAG='N' AND SSNO=#{ssno}
    </select>

    <delete id="deleteSch" parameterType="com.devkbil.mtssbj.schedule.SchVO">
        UPDATE SCH_SCHEDULE
           SET DELETEFLAG='Y'
         WHERE SSNO=#{ssno} 
    </delete>

    <!-- 아래는 comdate.xml에서 병합된 쿼리들 -->
    <insert id="insertComDate" parameterType="com.devkbil.mtssbj.schedule.DateVO">
        <selectKey keyProperty="cdno" resultType="Long" order="BEFORE">
            SELECT CDNO_SEQ.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO COM_DATE (
            CDNO, CDDATE, CDYEAR, CDMM, CDDD, CDWEEKOFYEAR, CDWEEKOFMONTH, CDWEEK, CDDAYOFWEEK
        ) VALUES (
            #{cdno}, #{date}, #{year}, #{month}, #{day}, #{weekOfYear}, #{weekOfMonth}, #{week}, #{dayOfWeek}
        )
    </insert>

    <select id="selectMaxDate" resultType="String">
        SELECT MAX(CDDATE)
        FROM COM_DATE
    </select>

    <select id="existsByDate" resultType="boolean">
        SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
        FROM COM_DATE
        WHERE CDDATE = #{date}
    </select>
</mapper>
