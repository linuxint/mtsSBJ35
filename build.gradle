/*
 * This file was generated by the Gradle 'init' task.
 */
import org.cyclonedx.gradle.CycloneDxTask

plugins {
    id 'org.springframework.boot' version '3.5.0-M2'
    id 'io.spring.dependency-management' version '1.1.7'
    id 'maven-publish'
    id 'java'
    id 'org.springdoc.openapi-gradle-plugin' version '1.9.0'
    id 'checkstyle'
    id 'com.diffplug.spotless' version '7.0.2'
    id 'org.cyclonedx.bom' version '2.2.0'
    id 'com.github.johnrengelman.shadow' version '8.1.1'
}

// Project Information
group = 'com.devkbil'
version = '1.3.0'
description = 'mtsSBJ35'

// Repository Configuration
repositories {
    mavenCentral()
    gradlePluginPortal()
    maven { 
        url = 'https://repo.spring.io/milestone'
        name = 'Spring Milestone'
    }
    maven { 
        url = 'https://repo.spring.io/snapshot'
        name = 'Spring Snapshot'
    }
    maven { 
        url = 'https://artifacts.elastic.co/maven'
        name = 'Elasticsearch Maven'
    }
    maven {
        url = 'https://repo.clojars.org'
        name = 'Clojars'
    }
}

springBoot {
    buildInfo()
}

// 각 configuration에 대한 exclude 설정
configurations.configureEach {
    exclude group: 'com.itextpdf', module: 'itextpdf' // iTextPDF 제외
}

dependencyManagement {
    imports {
        mavenBom('org.springframework.boot:spring-boot-dependencies:3.5.0-M2') {
//            bomProperty 'spring-framework.version', '7.0.0-M2'
//            bomProperty 'spring-security.version', '6.5.0-M2'
//            bomProperty 'spring-session.version', '3.4.2'
//            bomProperty 'spring-integration.version', '6.5.0-M2'
//            bomProperty 'spring-hateoas.version', '3.0.0-M1'
//            bomProperty 'spring-retry.version', '2.0.11'
        }
        mavenBom('org.springframework.data:spring-data-bom:2025.1.0-M1') {
            bomProperty 'spring-data-jpa', '4.0.0-M1'
            bomProperty 'spring-data-jdbc', '4.0.0-M1'
            bomProperty 'spring-data-elasticsearch', '6.0.0-M1'
            bomProperty 'spring-data-commons', '4.0.0-M1'
            bomProperty 'spring-data-relational', '4.0.0-M1'
        }
    }
}

dependencies {
    // ======================
    // 1. Platform & BOM
    // ======================
//    implementation platform("org.springframework.data:spring-data-bom:2025.1.0-M1")
//    implementation platform("org.springframework.integration:spring-integration-bom:6.5.0-M2")
//    implementation platform("org.springframework.ai:spring-ai-bom:1.0.0-M6")
    implementation platform("com.fasterxml.jackson:jackson-bom:2.18.3")
    implementation platform("io.micrometer:micrometer-bom:1.15.0-M2")
//    implementation platform("org.springframework.modulith:spring-modulith-bom:1.4.0-M1")

    // ======================
    // 2. Spring Boot 핵심 Starter
    // ======================
    // Spring MVC 및 웹 관련
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-thymeleaf'

    // 모니터링 및 관리
    implementation 'org.springframework.boot:spring-boot-starter-actuator'
    implementation 'org.springframework.boot:spring-boot-actuator-autoconfigure'

    // 개발 도구 및 유틸리티
    implementation 'org.springframework.boot:spring-boot-starter-aop'
    implementation 'org.springframework.boot:spring-boot-configuration-processor'
    implementation 'org.springframework.boot:spring-boot-devtools'

    // 캐시 관련
    implementation 'org.springframework.boot:spring-boot-starter-cache'
    implementation 'com.github.ben-manes.caffeine:caffeine:3.2.0'
//    implementation 'org.ehcache:ehcache' //:3.10.8

    // 코드 품질
    checkstyle 'com.puppycrawl.tools:checkstyle:10.21.4'

    // ======================
    // 3. Spring Data & Integration
    // ======================
    // JPA & Database
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-data-jdbc'
    implementation 'org.springframework.session:spring-session-jdbc'

    // Integration
    implementation 'org.springframework.boot:spring-boot-starter-integration'
    implementation 'org.springframework.integration:spring-integration-core'
    implementation 'org.springframework.integration:spring-integration-file'
    implementation 'org.springframework.integration:spring-integration-sftp'

    // Email
    implementation 'org.springframework.boot:spring-boot-starter-mail'
    implementation 'org.springframework.integration:spring-integration-mail'

    // ======================
    // 4. Security & Authentication
    // ======================
    // Core Security
    implementation 'org.springframework.boot:spring-boot-starter-security'
    implementation 'org.thymeleaf.extras:thymeleaf-extras-springsecurity6:3.1.3.RELEASE'

    // Authentication
    implementation 'io.jsonwebtoken:jjwt:0.12.6'
    implementation 'com.warrenstrange:googleauth:1.5.0'

    // ======================
    // 5. Jakarta EE & Server
    // ======================
    // Jakarta APIs
    implementation 'jakarta.servlet:jakarta.servlet-api:6.1.0'
    implementation 'jakarta.servlet.jsp:jakarta.servlet.jsp-api:4.0.0'
    implementation 'jakarta.servlet.jsp.jstl:jakarta.servlet.jsp.jstl-api:3.0.2'
    implementation 'jakarta.el:jakarta.el-api:6.0.1'
    implementation 'jakarta.faces:jakarta.faces-api:4.1.2'
    implementation 'jakarta.xml.bind:jakarta.xml.bind-api:4.0.2'

    // Implementation Libraries
    implementation 'org.glassfish.web:jakarta.servlet.jsp.jstl:3.0.1'
    implementation 'org.glassfish.jaxb:jaxb-runtime:4.0.5'
    implementation 'org.thymeleaf:thymeleaf-spring6:3.1.3.RELEASE'

    // Embedded Tomcat
    runtimeOnly 'org.springframework.boot:spring-boot-starter-tomcat'
    implementation 'org.apache.tomcat.embed:tomcat-embed-core:11.0.4'
    implementation 'org.apache.tomcat.embed:tomcat-embed-websocket:11.0.4'
    implementation 'org.apache.tomcat.embed:tomcat-embed-el:11.0.4'
    implementation 'org.apache.tomcat.embed:tomcat-embed-jasper:11.0.4'
    implementation 'org.apache.tomcat:tomcat-annotations-api:11.0.4'
//    runtimeOnly 'org.apache.tomcat:tomcat-native:1.2.35'

//    runtimeOnly 'org.springframework.boot:spring-boot-starter-jetty'        // 내장 Tomcat 런타임
//    implementation 'org.eclipse.jetty.http3:jetty-http3:12.0.16' // Jetty HTTP/3 의존성 추가
//    implementation 'org.eclipse.jetty.ee10:jetty-ee10-apache-jsp:12.0.16' // J SP 처리 엔진
//    implementation 'org.eclipse.jetty.ee10:jetty-ee10-servlet:12.0.16'   // 서블릿 지원
//    implementation 'org.eclipse.jetty.ee10:jetty-ee10-webapp:12.0.16'
//    implementation 'org.eclipse.jetty:jetty-server:12.0.16'
//    implementation 'org.eclipse.jetty:jetty-session:12.0.16'

//    implementation 'org.eclipse.jetty:jetty-webapp:11.0.24'
//    implementation 'org.eclipse.jetty:jetty-servlet:11.0.24'
//    implementation 'org.eclipse.jetty:apache-jsp:11.0.24'
//    implementation 'org.eclipse.jetty:jetty-annotations:11.0.24'

    // ======================
    // 6. Database & Persistence
    // ======================
    // JDBC Drivers
    implementation 'org.xerial:sqlite-jdbc:3.49.1.0'
    implementation 'com.oracle.database.jdbc:ojdbc11:23.7.0.25.01'
    runtimeOnly 'org.mariadb.jdbc:mariadb-java-client:3.5.2'
    runtimeOnly 'com.h2database:h2:2.3.232'

    // ORM & SQL Mappers
    implementation 'org.mybatis.spring.boot:mybatis-spring-boot-starter:3.0.4'

    // ======================
    // 7. Search Engine & Elasticsearch
    // ======================
    // Elasticsearch Core
    implementation 'org.springframework.boot:spring-boot-starter-data-elasticsearch'
    implementation 'co.elastic.clients:elasticsearch-java:9.0.0-beta1'
    implementation 'org.elasticsearch.client:elasticsearch-rest-client:9.0.0-beta1'
    implementation 'org.elasticsearch.client:elasticsearch-rest-high-level-client:7.17.28'

    // HTTP Client for Elasticsearch
    implementation 'org.apache.httpcomponents.client5:httpclient5:5.5-alpha1'

    // Elasticsearch Test
    testImplementation 'org.testcontainers:elasticsearch:1.20.5'
    testImplementation 'org.springframework.boot:spring-boot-starter-data-elasticsearch'

    // ======================
    // 8. Logging & Monitoring
    // ======================
    // Micrometer & Metrics
    implementation 'io.micrometer:micrometer-core'
    implementation 'io.micrometer:micrometer-registry-prometheus'
    implementation 'io.micrometer:micrometer-jakarta9'
    implementation 'io.micrometer:micrometer-observation'
    implementation 'io.micrometer:micrometer-commons'
    implementation 'io.micrometer:micrometer-tracing:1.5.0-M2'

    // Database Monitoring
    implementation 'com.github.gavlyukovskiy:p6spy-spring-boot-starter:1.10.0'
    implementation 'com.github.gavlyukovskiy:datasource-proxy-spring-boot-starter:1.10.0'
    implementation 'com.github.gavlyukovskiy:flexy-pool-spring-boot-starter:1.10.0'
    implementation 'net.ttddyy:datasource-proxy:1.10.1'

    // Application Monitoring
    implementation 'de.codecentric:spring-boot-admin-starter-client:3.4.4'

    // Distributed Tracing
    implementation 'org.springframework.cloud:spring-cloud-starter-sleuth:3.1.11'
    implementation 'org.springframework.cloud:spring-cloud-starter-zipkin:2.2.8.RELEASE'

    // ======================
    // 9. Encryption & Security Utils
    // ======================
    // Bouncy Castle Security Provider
    implementation 'org.bouncycastle:bcjmail-jdk18on:1.80'
    implementation 'org.bouncycastle:bcpkix-jdk18on:1.80'
    implementation 'org.bouncycastle:bcprov-jdk18on:1.80'
    implementation 'org.bouncycastle:bcutil-jdk18on:1.80'

    // ======================
    // 10. File & Document Processing
    // ======================
    // Document Parsing
    implementation 'org.apache.tika:tika-core:3.1.0'
    implementation 'org.apache.tika:tika-parsers-standard-package:3.1.0'
    annotationProcessor 'org.apache.tika:tika-core:3.1.0'

    // Office Documents
    implementation 'org.apache.poi:poi-ooxml:5.4.0'
    implementation 'org.jxls:jxls-poi:3.0.0'
    implementation 'net.sf.mpxj:mpxj:13.10.0'
    implementation 'net.freeutils:jtnef:2.1.0'

    // PDF Processing
    implementation 'org.apache.pdfbox:pdfbox:3.0.4'
    implementation 'org.apache.pdfbox:jbig2-imageio:3.0.4'

    // Image Processing
    implementation 'com.github.jai-imageio:jai-imageio-core:1.4.0'
    implementation 'com.github.jai-imageio:jai-imageio-jpeg2000:1.4.0'
    implementation 'com.twelvemonkeys.imageio:imageio-jpeg:3.12.0'

    // Other Formats
    implementation 'com.google.zxing:javase:3.5.3'
    implementation 'org.mnode.ical4j:ical4j:4.1.0'
    implementation 'com.ibm.icu:icu4j:76.1'

    // ======================
    // 11. API Documentation
    // ======================
    implementation 'org.springdoc:springdoc-openapi-starter-webmvc-ui:2.8.5'

    // ======================
    // 12. Testing
    // ======================
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testImplementation 'org.mockito:mockito-core:5.16.0'

    // ======================
    // 13. Utilities
    // ======================
    // Common Utils
    implementation 'com.google.guava:guava:33.4.0-jre'
    implementation 'org.modelmapper:modelmapper:3.2.2'
    implementation 'org.jodd:jodd-util:6.3.0'
    implementation 'org.apache.commons:commons-lang3:3.17.0'
    implementation 'org.apache.commons:commons-text:1.13.0'

    // Code Quality
    implementation 'io.spring.javaformat:spring-javaformat-gradle-plugin:0.0.43'
    checkstyle 'io.spring.javaformat:spring-javaformat-checkstyle:0.0.43'
    runtimeOnly 'io.spring.javaformat:spring-javaformat-config:0.0.43'
    runtimeOnly 'io.spring.javaformat:spring-javaformat-intellij-idea-plugin:0.0.43'

    // ======================
    // 14. Persistence & Validation
    // ======================
    // Hibernate
    implementation 'org.hibernate.validator:hibernate-validator:9.0.0.CR1'
    implementation 'org.hibernate.orm:hibernate-core:7.0.0.Beta4'
    implementation 'org.hibernate.orm:hibernate-jcache:7.0.0.Beta4'

    // Jakarta Persistence
    implementation 'jakarta.validation:jakarta.validation-api:3.1.1'
    implementation 'jakarta.persistence:jakarta.persistence-api:3.2.0'

    // Lombok
    implementation 'org.projectlombok:lombok:1.18.36'
    annotationProcessor 'org.projectlombok:lombok:1.18.36'
    testAnnotationProcessor 'org.projectlombok:lombok:1.18.36'

    // ======================
    // 15. Communication & Messaging
    // ======================
    // Rate Limiting
    implementation 'com.bucket4j:bucket4j_jdk17-oracle:8.14.0'

    // Web Communication
    implementation 'org.springframework.boot:spring-boot-starter-json'
    implementation 'org.springframework.boot:spring-boot-starter-websocket'

    // ======================
    // 16. Additional Database Tools
    // ======================
    // JOOQ
    implementation 'org.springframework.boot:spring-boot-starter-jooq'
    implementation 'org.jooq:jooq:3.20.1'
    implementation 'org.jooq:jooq-codegen:3.20.1'
    // jood.sql-dialect: ORACLE // application.properties || application.yml
    // 세선 DB

    // 미정렬
    //implementation 'org.springframework.ai:spring-ai-bedrock-converse-spring-boot-starter'

    // ======================
    // 17. Miscellaneous
    // ======================
    // Network
    runtimeOnly 'io.netty:netty-resolver-dns-native-macos:4.2.0.RC3'

    // Version Control
    implementation 'org.eclipse.jgit:org.eclipse.jgit:7.1.0.202411261347-r'

    // External Libraries
    implementation fileTree(dir: 'lib', include: ['*.jar'])
}

// ======================
// Build Configuration
// ======================

// Checkstyle Configuration
tasks.withType(Checkstyle).configureEach { task ->
    task.reports {
        xml.required = false
        html.required = true
        html.outputLocation = layout.buildDirectory.file("reports/checkstyle.html").get().asFile
    }
    ignoreFailures = true
    showViolations = true
}

// Test Configuration
tasks.named('test').configure {
    useJUnitPlatform()
}

// Clean Configuration
tasks.named('clean').configure {
    delete(layout.projectDirectory.dir('logs_local'))
    delete(layout.projectDirectory.dir('logs_dev'))
    delete(layout.projectDirectory.dir('logs_stag'))
    delete(layout.projectDirectory.dir('logs_prod'))
    delete(layout.projectDirectory.dir('out'))
    delete(layout.projectDirectory.dir('logs'))
    delete(layout.projectDirectory.dir('work'))
}

// External Libraries Configuration
tasks.register('copyExternalLibs', Copy) {
    from configurations.runtimeClasspath
    include 'spring-javaformat-config-*.jar'
    include 'spring-javaformat-checkstyle-*.jar'
    include 'spring-javaformat-intellij-idea-plugin-*.jar'
    into project.file('3dparty')
}

// Encoding Configuration
allprojects {
    tasks.withType(JavaCompile).configureEach {
        options.encoding = 'UTF-8'
    }

    tasks.withType(Test).configureEach {
        systemProperty 'file.encoding', 'UTF-8'
    }

    tasks.withType(JavaExec).configureEach {
        systemProperty 'file.encoding', 'UTF-8'
    }
}

// ======================
// Code Style Configuration
// ======================
spotless {
    enforceCheck = false

    java {

        encoding 'UTF-8' // 파일 인코딩 명시

        toggleOffOn() // 방식 토글 지원

        // Target Files
        target 'src/**/*.java'

        // Import Management
        importOrder(
            "ch",
            "", "co",
            "", "com",
            "", "io",
            "", "jakarta",
            "", "lombok",
            "", "net",
            "", "org",
            "", "javax",
            "", "java",
            "", "\\#static"
        )

        // Code Style
        eclipse().configFile('codestyle/Naver_coding_convention_v1_2.xml')

        // Custom Rules
        custom 'Format comments with <pre>', { content ->
            content.replaceAll(/\/\*\*([\s\S]*?)\*\//, { String match, String body ->
                String updatedBody = body.replaceAll(/<p>/, "").replaceAll(/<\/p>/, "")
                def result = "/**\n *<pre>${updatedBody}\n *</pre>\n */"
                return result.toString() == match ? match : result
            })
        }}
}

// ======================
// Quality Checks Configuration
// ======================

// Checkstyle
checkstyle {
    maxWarnings = 0
    configFile = file("$rootDir/codestyle/naver-checkstyle-rules.xml")
    configProperties = [
        'suppressionFile': file("$rootDir/codestyle/naver-checkstyle-suppressions.xml")
    ]
    toolVersion = '10.21.3'
}

// Format Check
tasks.register("checkFormatMain") {
    dependsOn 'spotlessCheck'
}

// ======================
// SBOM Generation
// ======================
tasks.register('jvmCyclonedxBom', CycloneDxTask) {
    group = 'reporting'
    description = 'Generates an SBOM for only JVM dependencies'
    skipConfigs = configurations.names.findAll { it != 'compileClasspath' }
    outputName.set("jvm-sbom")
    destination.set(file("src/main/resources"))
    outputFormat.set('json')
}

tasks.register('appCyclonedxBom', CycloneDxTask) {
    group = 'reporting'
    description = 'Generates an SBOM for the application runtime dependencies'
    skipConfigs.set(configurations.names - 'runtimeClasspath')
    outputName.set("application-sbom")
    destination.set(file("src/main/resources"))
    outputFormat.set('json')
}

// Build Dependencies
build.dependsOn spotlessApply
build.dependsOn jvmCyclonedxBom, appCyclonedxBom

tasks.processResources {
    // appCyclonedxBom 작업의 출력이 processResources 작업의 입력임을 정의
    inputs.files(tasks.appCyclonedxBom.outputs.files)
    dependsOn tasks.appCyclonedxBom
}


tasks.spotlessJava {
    // appCyclonedxBom 작업 이후 실행되도록 의존성 설정
    inputs.files(tasks.appCyclonedxBom.outputs.files)
    dependsOn tasks.appCyclonedxBom
}